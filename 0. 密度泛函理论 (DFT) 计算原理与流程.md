## 一、引言：多体问题的挑战 ⚛️

### 1.1 微观世界的复杂性

17 世纪末，牛顿经典力学成功描述了宏观物体的运动规律。然而，到了 19 世纪末，一些实验现象，如黑体辐射、光电效应和原子光谱，无法用经典力学解释，这推动了科学研究向更微观的层面深入。

1900 年，普朗克提出了量子假说，认为能量的发射和吸收是一份一份的，这个最小单位被称为“量子”。随后，爱因斯坦基于此解释了光电效应，提出了“光量子”（即光子）的概念。1913 年，玻尔的原子模型进一步解释了原子光谱。最终，海森堡的矩阵力学和薛定谔的波动力学殊途同归，共同奠定了量子力学的基础，揭示了微观粒子的波粒二象性。

在量子力学中，微观粒子的状态由波函数 $\Psi(\vec{r}, t)$ 来描述。波函数的演化遵循薛定谔方程。对于不含时的情况（定态），薛定谔方程简化为能量本征方程：
$$ \hat{H}\psi(\vec{r})=E\psi(\vec{r}) $$
其中 $\hat{H}$ 是体系的哈密顿算符，$\psi(\vec{r})$ 是不含时波函数，$E$ 是体系的能量。

### 1.2 多体薛定谔方程的困境

对于一个包含 $N_e$ 个电子和 $N_n$ 个原子核的体系，其完整哈密顿算符形式复杂：
$$ \hat{H}=-\sum*i^{N_e} \frac{\hbar^2}{2 m_e} \nabla_i^2-\sum_A^{N_n} \frac{\hbar^2}{2 m_A} \nabla_A^2-\sum_i^{N_e} \sum_A^{N_n} \frac{Z_A e^2}{4\pi\epsilon_0 r*{iA}}+\sum*{i<j}^{N_e} \frac{e^2}{4\pi\epsilon_0 r*{ij}}+\sum*{A<B}^{N_n} \frac{Z_A Z_B e^2}{4\pi\epsilon_0 r*{AB}} $$
各项依次代表：电子动能、原子核动能、电子-原子核吸引势能、电子-电子排斥势能、原子核-原子核排斥势能。
这个方程的波函数 $\psi$ 依赖于所有电子和原子核的坐标，共 $3(N_e+N_n)$ 个变量。即使对于只有几个电子的体系，如碳原子（6 个电子），在一个离散空间网格上求解该方程的维度也极其巨大，直接求解几乎是不可能的。正如狄拉克所言，基本物理定律是已知的，但方程过于复杂难以求解。因此，量子方法的一个重要内容就是研究多电子薛定谔方程的近似解法。

---

## 二、玻恩-奥本海默近似 (Born-Oppenheimer Approximation) tách

由于原子核的质量远大于电子质量（$m_A \gg m_e$），原子核的运动速度远慢于电子。玻恩-奥本海默近似基于此，将原子核和电子的运动解耦：

1.  **原子核固定**：在求解电子运动时，认为原子核的位置是固定的。
2.  **电子瞬时响应**：电子则瞬时地适应原子核构型的变化。

在此近似下，原子核动能项在电子哈密顿量中被忽略，原子核-原子核排斥项则成为一个常数（对于固定的核构型）。电子哈密顿量简化为（常采用原子单位制，$\hbar=m_e=e=4\pi\epsilon_0=1$）：
$$ \hat{H}_{el} = \hat{T}\_e + \hat{V}_{ext} + \hat{V}_{ee} = -\frac{1}{2} \sum_i^{N_e} \nabla_i^2 - \sum_i^{N_e} \sum_A^{N_n} \frac{Z_A}{|\vec{R}\_A - \vec{r}\_i|} + \sum_{i<j}^{N*e} \frac{1}{|\vec{r}\_i - \vec{r}\_j|} $$
其中 $\vec{R}_A$ 是固定的原子核坐标，$\vec{r}_i$ 是电子坐标。此时，波函数仅是电子坐标的函数，变量数降为 $3N_e$。尽管如此，由于电子-电子相互作用项 $\hat{V}*{ee}$ 的存在，求解仍然非常困难。

---

## 三、DFT 的基石：Hohenberg-Kohn 定理 🔑

1964 年，Hohenberg 和 Kohn 提出了两项奠基性的定理，构成了密度泛函理论 (DFT) 的理论基础。这些定理从根本上改变了处理多电子问题的方式。

### 3.1 Hohenberg-Kohn 第一定理：电子密度作为基本变量

- **内容**：对于一个处于非简并基态的多电子体系，其外部势场 $v_{ext}(\vec{r})$ （在玻恩-奥本海默近似下，主要由固定的原子核产生）与基态电子密度 $n_0(\vec{r})$ 之间存在一一对应关系。
- **推论与意义**：
  - 由于 $v_{ext}(\vec{r})$ 决定了体系的电子哈密顿量 $\hat{H}_{el}$，而哈密顿量决定了体系所有的基态性质（包括基态多电子波函数），因此，**基态电子密度 $n_0(\vec{r})$ 唯一地决定了体系所有的基态电子性质**。
  - 这是一个巨大的简化。原本需要处理依赖于 $3N_e$ 个电子坐标的复杂多体波函数，现在转变为处理一个仅依赖于三个空间坐标 $\vec{r}=(x,y,z)$ 的标量函数——电子密度 $n(\vec{r})$。

### 3.2 Hohenberg-Kohn 第二定理：能量的变分原理

- **内容**：对于任意给定的外部势场 $v_{ext}(\vec{r})$，存在一个普适的能量泛函 $E[n(\vec{r})]$ （普适意味着其形式不依赖于具体的 $v_{ext}(\vec{r})$）。对于任何满足粒子数守恒的尝试电子密度 $n(\vec{r})$，通过此泛函计算得到的能量 $E[n(\vec{r})]$ 必然大于或等于真实的基态能量 $E_0$。当且仅当 $n(\vec{r})$ 是真实的基态电子密度 $n_0(\vec{r})$ 时，等号成立。
  $$ E*0 = \min*{n(\vec{r})} E[n(\vec{r})] $$
- **意义**：此定理为通过最小化能量泛函来寻找基态电子密度和基态能量提供了理论依据。

**HK 定理的局限性**：这两个定理是严格的，证明了以电子密度为核心变量的可行性。但是，它们并没有给出那个普适能量泛函 $E[n(\vec{r})]$ 的具体形式，特别是其中最难处理的电子动能和电子-电子相互作用部分。

---

## 四、Kohn-Sham 方法：DFT 的实用化框架 🛠️

为了使 DFT 能够实际应用于计算，1965 年，Walter Kohn 和 Lu Jeu Sham 提出了一种天才的方案，即 Kohn-Sham (KS) DFT。

### 4.1 核心思想：引入辅助的无（或弱）相互作用体系

KS 方法的核心思想是：用一个**假想的、名义上无相互作用的电子体系**来代替真实的、有相互作用的电子体系。这个辅助体系被巧妙地构建，使得其**基态电子密度与真实相互作用体系的基态电子密度完全相同**。

### 4.2 Kohn-Sham 方程

既然辅助体系中的电子是名义上无相互作用的（它们只感受到一个等效的平均场），那么每个电子的行为可以用一个独立的单粒子薛定谔方程来描述，这就是 **Kohn-Sham 方程**：
$$ \left[ -\frac{1}{2}\nabla^2 + v_{KS}(\vec{r}) \right] \phi_i(\vec{r}) = \epsilon_i \phi_i(\vec{r}) $$
(原子单位制)
其中：

- $\phi_i(\vec{r})$ 是第 $i$ 个 Kohn-Sham 轨道（单电子波函数）。
- $\epsilon_i$ 是对应的 Kohn-Sham 轨道能量。
- $v_{KS}(\vec{r})$ 是 **Kohn-Sham 等效势场**。

一旦求解了 Kohn-Sham 方程，得到了 KS 轨道，体系的电子密度就可以通过对所有占据轨道的模平方求和得到：
$$ n(\vec{r}) = \sum*{i=1}^{N*{occ}} f*i |\phi_i(\vec{r})|^2 $$
其中 $N*{occ}$ 是（可能）占据的 KS 轨道数目，$f_i$ 是第 $i$ 个轨道的占据数（对于绝缘体或在零温下，通常为 0, 1 或 2，取决于自旋；对于金属，可能是分数占据，由费米-狄拉克分布 $f(\epsilon_i - \mu)$ 决定）。

### 4.3 Kohn-Sham 等效势场 $v_{KS}(\vec{r})$

Kohn-Sham 等效势场由三部分组成：
$$ v*{KS}(\vec{r}) = v*{ext}(\vec{r}) + v*H(\vec{r}) + v*{xc}(\vec{r}) $$

- **$v_{ext}(\vec{r})$**：外部势场，通常是原子核对电子的库仑吸引势，与真实体系中的相同。
- **$v_H(\vec{r})$ (Hartree 势)**：电子间的经典静电排斥势（也称为库仑作用项 $V_{ee}$ 的一部分），可以由电子密度 $n(\vec{r})$ 计算得到：
  $$ v_H(\vec{r}) = \int \frac{n(\vec{r}')}{|\vec{r}-\vec{r}'|} d\vec{r}' $$
  (原子单位制)
- **$v_{xc}(\vec{r})$ (交换关联势)**：这是 KS 方法中最核心也最复杂的部分。它是一个有效势，包含了所有因将真实相互作用体系映射到名义上无相互作用辅助体系而“遗漏”的复杂量子力学多体效应，主要是电子间的交换效应和非经典的关联效应。它由交换关联能量泛函 $E_{xc}[n]$ 对电子密度 $n(\vec{r})$ 求泛函导数得到：
  $$ v*{xc}(\vec{r}) = \frac{\delta E*{xc}[n(\vec{r})]}{\delta n(\vec{r})} $$

### 4.4 Kohn-Sham 体系的总能量

在 Kohn-Sham 框架下，体系的总能量泛函可以准确地写为：
$$ E*{KS}[n] = T_s[n] + \int n(\vec{r})v*{ext}(\vec{r})d\vec{r} + E*H[n] + E*{xc}[n] + E\_{NN} $$
其中：

- **$T_s[n]$**：名义上无相互作用的 Kohn-Sham 电子的动能。它可以精确地通过 Kohn-Sham 轨道计算：
  $$ T*s[n] = \sum*{i=1}^{N\_{occ}} f_i \int \phi_i^\*(\vec{r}) \left( -\frac{1}{2}\nabla^2 \right) \phi_i(\vec{r}) d\vec{r} $$
- $\int n(\vec{r})v_{ext}(\vec{r})d\vec{r}$：电子在外部势场中的能量。
- **$E_H[n]$ (Hartree 能)**：电子云的经典静电自相互作用能：
  $$ E_H[n] = \frac{1}{2} \iint \frac{n(\vec{r})n(\vec{r}')}{|\vec{r}-\vec{r}'|} d\vec{r}d\vec{r}' $$
- **$E_{xc}[n]$ (交换关联能)**：这是所有“未知”和“困难”的多体效应（包括真实动能与 $T_s[n]$ 的差以及非经典的电子-电子相互作用）的总和。**它是 DFT 计算中唯一需要近似处理的部分。**
- **$E_{NN}$**：原子核-原子核间的排斥能，对于固定的核构型是一个常数。

注意：总能量不是简单地对 Kohn-Sham 轨道能量求和。一种常见的总能量表达式为：
$$ E*{tot} = \sum*{i=1}^{N*{occ}} f_i \epsilon_i - E_H[n] + E*{xc}[n] - \int v*{xc}(\vec{r})n(\vec{r})d\vec{r} + E*{NN} $$
或者使用 中提到的 $E_{tot} = \sum_{i=1}^{N} f(\epsilon_i - \mu) \epsilon_i + E_{ext}[n] + E_{H}[n] + E_{xc}[n]$ （其中 $E_{ext}[n]$ 应为外部势能项，该公式需要确保与标准定义一致，通常用 $T_s$ 更清晰）。

---

## 五、交换关联泛函 ($E_{xc}[n]$)：DFT 的核心近似 🎯

尽管 Kohn-Sham 方法提供了一个在形式上精确求解基态密度和能量的框架，但**精确的交换关联能量泛函 $E_{xc}[n]$ 的形式是未知的**。因此，DFT 的实际应用依赖于对 $E_{xc}[n]$ 的近似。这是 DFT 方法的核心，也是其精度和局限性的主要来源。

目前已经发展出多种近似的交换关联泛函，通常被形象地称为“雅各布天梯 (Jacob's Ladder of DFT)”，代表了从简单到复杂的不同精度层次：

1.  **局域密度近似 (Local Density Approximation, LDA)**：

    - $E_{xc}^{LDA}[n] = \int \epsilon_{xc}^{hom}(n(\vec{r})) n(\vec{r}) d\vec{r}$
    - 假设体系中每一点的交换关联能密度只依赖于该点的电子密度值 $n(\vec{r})$，并且其形式与均匀电子气 (Homogeneous Electron Gas, HEG) 的相同。
    - LDA 是最简单的泛函，对于结构相对紧密的体系的结构性质有时能给出合理结果，但通常会过高估计结合能，并显著低估带隙。

2.  **广义梯度近似 (Generalized Gradient Approximation, GGA)**：

    - $E_{xc}^{GGA}[n, \nabla n] = \int f(n(\vec{r}), |\nabla n(\vec{r})|) d\vec{r}$
    - 除了依赖于局域电子密度 $n(\vec{r})$，还依赖于电子密度的梯度 $|\nabla n(\vec{r})|$。这使得 GGA 能够更好地描述电子密度不均匀的体系。
    - 常见的 GGA 泛函有 PBE (Perdew-Burke-Ernzerhof) (在赝势命名中提及), PW91 (Perdew-Wang 1991), BLYP (Becke-Lee-Yang-Parr) 等。
    - GGA 通常比 LDA 在化学键能、原子化能等方面有显著改进，对带隙的低估仍然存在。

3.  **Meta-GGA 泛函 (mGGA)**：

    - $E_{xc}^{mGGA}[n, \nabla n, \tau_s \text{ or } \nabla^2 n]$
    - 在 GGA 的基础上，进一步引入了与 Kohn-Sham 轨道相关的动能密度 $\tau_s(\vec{r}) = \frac{1}{2}\sum_i^{occ} |\nabla\phi_i(\vec{r})|^2$ 或电子密度的拉普拉斯算子 $\nabla^2 n(\vec{r})$。
    - 常见的 mGGA 泛函有 SCAN (Strongly Constrained and Appropriately Normed), TPSS (Tao-Perdew-Staroverov-Scuseria) 等。
    - mGGA 有望在不显著增加计算成本的情况下提供比 GGA 更高的精度。

4.  **杂化泛函 (Hybrid Functionals)**：

    - 这类泛函将一部分精确的 Hartree-Fock (HF) 交换能（源自波函数理论）与 GGA 或 mGGA 的交换能和关联能混合起来。
    - 例如：$E_{xc}^{hybrid} = a E_x^{HF} + (1-a)E_x^{GGA/mGGA} + E_c^{GGA/mGGA}$，其中 $a$ 是混合系数。
    - 常见的杂化泛函有 B3LYP, PBE0, HSE (Heyd-Scuseria-Ernzerhof) 等。
    - 杂化泛函通常能显著改善对带隙、分子性质（如反应能垒）的预测，但计算成本远高于 LDA/GGA/mGGA，因为计算 HF 交换能的代价较高。

5.  **更高级的近似**：
    - 例如基于随机相位近似 (RPA) 的关联能计算，双杂化泛函等，它们力求更高的精度，但计算成本也相应更高。
    - **范德华 (van der Waals) / 色散修正**：标准 LDA/GGA 难以描述长程范德华力。现代 DFT 方法发展了多种色散修正方案 (如 DFT-D 系列，vdW-DF 系列泛函) 来改善这类弱相互作用的描述。

**选择合适的交换关联泛函对于获得可靠的 DFT 计算结果至关重要。** 不同的泛函在预测不同性质或不同类型体系时表现各异，没有一种泛函是万能的。赝势也需要与所选的交换关联泛函兼容，例如 PAW-PBE 赝势需搭配 PBE 泛函使用。

---

## 六、自洽场 (Self-Consistent Field, SCF) 计算流程 🔄

由于 Kohn-Sham 等效势场 $v_{KS}(\vec{r})$ （通过 Hartree 势和交换关联势）依赖于电子密度 $n(\vec{r})$，而电子密度又是由解 Kohn-Sham 方程（其本身包含 $v_{KS}(\vec{r})$）得到的 KS 轨道所构成。这是一个典型的“先有鸡还是先有蛋”的问题，需要通过迭代的方式求解，直到达到自洽状态。这个过程称为**自洽场 (SCF) 循环**或**电子步 (electronic step)**。

SCF 循环的主要步骤如下 (参考图 1 和 Source 2 的描述)：

1.  **步骤 0：初始猜测 (Initialization)**

    - 对体系的电子密度 $n^{(0)}(\vec{r})$ (例如，来自叠加的原子密度) 或 Kohn-Sham 轨道 $\phi_i^{(0)}(\vec{r})$ 进行一个初始猜测。
    - 选定交换关联泛函 $E_{xc}[n(\vec{r})]$ 的近似形式。

2.  **步骤 1：构建 Kohn-Sham 哈密顿量**

    - 利用当前迭代步的电子密度 $n^{(k)}(\vec{r})$ 和选定的交换关联泛函，计算出 Hartree 势 $v_H^{(k)}(\vec{r})$ 和交换关联势 $v_{xc}^{(k)}(\vec{r})$。
    - 构建出当前迭代步的 Kohn-Sham 等效势场 $v_{KS}^{(k)}(\vec{r}) = v_{ext}(\vec{r}) + v_H^{(k)}(\vec{r}) + v_{xc}^{(k)}(\vec{r})$。
    - 由此得到 Kohn-Sham 哈密顿算符 $\hat{H}_{KS}^{(k)} = -\frac{1}{2}\nabla^2 + v_{KS}^{(k)}(\vec{r})$ (原子单位制)。

3.  **步骤 2：求解 Kohn-Sham 方程**

    - 求解当前迭代步的 Kohn-Sham 方程：$\hat{H}_{KS}^{(k)} \phi_i^{(k+1)}(\vec{r}) = \epsilon_i^{(k+1)} \phi_i^{(k+1)}(\vec{r})$。这通常通过将哈密顿矩阵在选定的基组中对角化来完成 (提及`ks_solver`参数)。
    - 得到一组新的 Kohn-Sham 轨道 $\phi_i^{(k+1)}(\vec{r})$ 和轨道能量 $\epsilon_i^{(k+1)}$。计算中 Kohn-Sham 轨道的数量由`nbands`参数指定。

4.  **步骤 3：计算新的电子密度**

    - 根据新的 Kohn-Sham 轨道和轨道能量（特别是对于金属体系，需要考虑费米-狄拉克分布 $f(\epsilon_i - \mu)$），计算出新的电子密度：
      $$ n^{(k+1)}(\vec{r}) = \sum*{i=1}^{N*{occ}} f_i |\phi_i^{(k+1)}(\vec{r})|^2 $$
    - 对于金属体系或费米面复杂的体系，为了帮助 SCF 收敛，通常会采用展宽技术 (smearing methods)，如 Methfessel-Paxton (`mp`), Gaussian (`gauss`) 或 Fermi-Dirac (`fd`) 展宽，通过 `smearing_sigma` 参数控制展宽能量范围。

5.  **步骤 4：判断收敛性**

    - 将新的电子密度 $n^{(k+1)}(\vec{r})$ 与上一轮的电子密度 $n^{(k)}(\vec{r})$ 进行比较，或者比较由它们计算得到的总能量 $E^{(k+1)}$ 和 $E^{(k)}$ 的差异，或者比较势场的差异。
    - 如果差异小于预设的收敛阈值（例如，电荷密度误差由`scf_thr`参数控制，能量差小于某值），则认为已达到自洽，SCF 循环结束。此时，$n^{(k+1)}(\vec{r})$ 和 $E^{(k+1)}$ 就是该原子构型下的基态电子密度和总能量。
    - 如果迭代次数达到最大限制 `scf_nmax` 仍未收敛，也可能停止计算，此时需要检查参数设置的合理性。

6.  **步骤 5：密度/势混合 (Mixing)**
    - 如果未达到收敛标准，为了加速收敛并防止迭代过程发生振荡，通常不会直接将新的密度 $n^{(k+1)}(\vec{r})$ 作为下一轮迭代的输入密度，而是将其与前几轮的密度进行某种方式的混合（例如线性混合、Pulay 混合、Broyden 混合等，通过 `mixing_type` 参数选择），得到用于第 $(k+1)$ 轮迭代开始时的输入密度 $n_{in}^{(k+1)}(\vec{r})$。混合比例由 `mixing_beta` 等参数控制。
    - 令 $n^{(k+1)}(\vec{r}) \leftarrow n_{in}^{(k+1)}(\vec{r})$ (或类似地更新势场/轨道)，然后返回步骤 1，开始新的迭代。

这个 SCF 循环会一直进行，直到满足收敛判据为止。对于给定的原子构型，完成一次 SCF 循环就意味着找到了该构型下的电子基态。

---

## 七、DFT 计算的实际实现细节概览 💻

在实际的 DFT 软件中，为了求解 Kohn-Sham 方程，还需要一些关键的数值技术。

### 7.1 基组 (Basis Sets)

Kohn-Sham 轨道 $\phi_i(\vec{r})$ 是未知的连续函数，为了在计算机上求解，需要将其展开在一组已知的**基函数**上：
$$ \phi*i(\vec{r}) = \sum*{\mu=1}^{M} c*{i\mu} \chi*{\mu}(\vec{r}) $$
其中 $\chi_{\mu}(\vec{r})$ 是基函数，$c_{i\mu}$ 是待求的展开系数。选择不同的基函数集合（即基组）会影响计算的精度和效率。`basis_type`参数用于指定计算的基组类型。

#### 7.1.1 平面波基组 (Plane Waves, PWs)

- **布洛赫定理与展开**：根据布洛赫定理，周期性势场中的电子波函数可以展开为平面波的线性组合：
  $$ \psi*{\mathbf{k}}(\mathbf{r}) = e^{i\mathbf{k} \cdot \mathbf{r}} u*{\mathbf{k}}(\mathbf{r}) = e^{i\mathbf{k} \cdot \mathbf{r}} \sum*{\mathbf{G}} c*{\mathbf{k}+\mathbf{G}} e^{i\mathbf{G} \cdot \mathbf{r}} = \sum*{\mathbf{G}} c*{\mathbf{k}+\mathbf{G}} e^{i(\mathbf{k}+\mathbf{G}) \cdot \mathbf{r}} $$
    其中 $\mathbf{k}$ 是位于第一布里渊区的波矢，$\mathbf{G}$ 是倒格矢。
- **能量截断 ($E_{cut}$ 或 `ecutwfc`)**：理论上需要无限多个平面波，实际计算中引入能量截断值，只包含动能小于 $E_{cut}$ 的平面波：
  $$ \frac{\hbar^2}{2m*e} |\mathbf{k} + \mathbf{G}|^2 \leq E*{cut} $$
    $E_{cut}$ (单位通常为 Ry 或 eV，ABACUS 中为 Ry) 决定了基组的大小和计算精度。更高的 $E_{cut}$ 意味着更完备的基组和更高的精度，但计算量也显著增加。
- **选择因素**：$E_{cut}$ 的选择需平衡计算精度与效率，并受到赝势类型（超软赝势通常需要较低的 $E_{cut}$，模守恒赝势则较高）和材料特性的影响。
- **优势**：
  - 正交归一，计算简便。
  - 仅需一个参数 ($E_{cut}$) 系统控制精度，收敛性明确。
  - 基组与原子位置无关，无基组叠加误差 (BSSE)。
  - 易于计算原子受力。
- **局限性**：
  - 描述原子核附近剧烈振荡的波函数需要极高的 $E_{cut}$，因此通常必须与赝势方法结合使用。
  - 对于真空层较大的非周期体系（如分子、表面），计算效率较低。

#### 7.1.2 局域原子轨道基组 (Localized Atomic Orbitals, LCAO / Numerical Atomic Orbitals, NAO)

- **数学形式**：将 KS 轨道展开为以原子为中心的局域化轨道函数的线性组合：
  $$ \psi*j(\mathbf{r}) = \sum*{I\mu} c*{j,I\mu} \chi*{I\mu}(\mathbf{r}-\mathbf{R}_I) $$
  其中 $\chi_{I\mu}(\mathbf{r}-\mathbf{R}_I)$ 是位于原子 $I$ （坐标 $\mathbf{R}_I$）上的第 $\mu$ 个原子轨道基函数。对于周期性体系，这些基函数需要构造成满足布洛赫定理的布洛赫和：
  $$ \chi_{\mu\mathbf{k}}(\mathbf{r}) = \sum*{\mathbf{L}} e^{i\mathbf{k}\cdot\mathbf{L}} \chi*{\mu}(\mathbf{r}-\mathbf{R}\_I-\mathbf{L}) $$
- **轨道类型**：常用的有数值原子轨道 (NAO)，斯莱特型轨道 (STO) 和高斯型轨道 (GTO)。ABACUS 支持 NAO，如 DZP (Double-Zeta plus Polarization) 或 TZDP (Triple-Zeta plus Double Polarization) 基组。这些基组的完备性（如轨道数量和类型）和截断半径（NAO 通常有径向截断）影响计算精度和效率。
- **优势**：
  - 基组规模相对较小，对于大体系或非周期体系计算效率较高。
  - 直观的化学图像。
  - 内存需求通常较低（由于哈密顿矩阵的稀疏性）。
- **局限性**：
  - 基组完备性不如平面波那样容易系统提升。
  - 可能存在基组叠加误差 (BSSE)。
  - 原子受力的计算比平面波复杂。
- **匹配性**：LCAO 计算所采用的数值原子轨道需要和对应的赝势匹配。

### 7.2 赝势 (Pseudopotentials, PPs)

赝势是一种近似方法，用一个平滑的有效势来替代原子实（原子核和内层芯电子）与价电子之间的强相互作用以及正交化要求。

- **核心思想**：
  1.  **冻芯近似 (Frozen Core Approximation)**：认为内层芯电子在化学成键过程中基本不变，将其与原子核的效应合并为一个等效的离子实势。
  2.  **波函数平滑化**：构造赝价电子波函数，使其在原子核区域外与真实价电子波函数一致，但在核心区平滑无节点。
  3.  **散射性质守恒**：赝势必须精确再现真实势对价电子的散射性质（通常通过保证在截断半径外的波函数模和对数导数相同，或相移相同）。
- **为什么需要赝势**：
  - 真实价电子波函数在原子核附近因正交于芯电子轨道而剧烈振荡，需要非常多的平面波（即非常高的 $E_{cut}$）才能准确描述。
  - 通过构造平滑的赝波函数，可以显著降低所需的 $E_{cut}$，从而大幅减少计算量。
- **常见类型**：
  - **模守恒赝势 (Norm-Conserving Pseudopotentials, NCPP)**：要求赝波函数在截断半径外的模（电荷）与真实波函数一致。例如 ONCV 赝势。
  - **超软赝势 (Ultrasoft Pseudopotentials, USPP)**：放宽了模守恒条件，允许更平滑的赝波函数，从而可以使用更低的 $E_{cut}$，但计算电荷密度时需要额外的补偿项。
  - **投影缀加波方法 (Projector Augmented Wave, PAW)**：一种更精确的方法，通过线性变换将在平滑赝波函数基础上计算的结果重构为等效的全电子结果。它严格来说并非传统赝势，但达到了类似的效果且精度通常更高。
- **应用与选择**：赝势的选择需考虑精度要求、计算效率以及与交换关联泛函的兼容性 (例如，PBE 泛函通常搭配 PBE 赝势)。赝势文件通常由专门的程序生成，并在 DFT 计算中通过输入文件（如 ABACUS 的`STRU`文件中的赝势文件名和`pseudo_dir`指定的目录）指定。

### 7.3 k 点取样 (k-point Sampling)

对于周期性体系（晶体），电子波函数遵循布洛赫定理，其性质需要在倒易空间（k 空间）的第一布里渊区 (BZ) 内进行积分才能得到体系的宏观平均值（如总能量、电子密度）。

- **第一布里渊区 (FBZ)**：倒易空间的原胞，通常取为倒格原点周围的 Wigner-Seitz 原胞。其边界对应电子波发生布拉格衍射的条件。
- **积分的离散化**：对整个 BZ 的积分在数值上通过在 BZ 内选取一组离散的 **k 点**进行求和来近似：
  $$ \int*{BZ} f(\mathbf{k}) d\mathbf{k} \approx \sum*{j} w_j f(\mathbf{k}\_j) $$
    其中 $\mathbf{k}_j$ 是选取的 k 点， $w_j$ 是对应的权重。
- **不可约布里渊区 (IBZ)**：利用晶体的对称性，可以将积分范围从整个 BZ 缩小到其一个对称不等价的部分，即 IBZ，从而减少独立计算的 k 点数目，提高计算效率。DFT 软件中`symmetry`参数的设置与此相关。
- **Monkhorst-Pack (MP) 网格**：一种常用的在 BZ 中生成均匀 k 点网格的方法。其 k 点坐标可以表示为：
  $$ \mathbf{k}_{n_1,n_2,n_3} = \sum_{i=1}^3 \frac{2u_i - N_i -1}{2N_i} \mathbf{b}\_i $$
    (公式略有出入，Source 1 使用 $n_i$ 作为计数，$N_i$ 作为密度，$\mathbf{G}_i$ 作为倒格子基矢，这里采用常见的 $\mathbf{b}_i$ 表示倒格子基矢，并调整了计数和偏移以匹配标准 MP 方案)。实际软件中（如 ABACUS 的`KPT`文件）会指定网格密度 (如 $N_x \times N_y \times N_z$) 和可能的网格中心偏移 (如 Gamma 中心网格)。
- **k 点密度的选择**：
  - **金属**：由于费米面附近电子态变化剧烈，通常需要较密的 k 点网格。
  - **半导体/绝缘体**：能带结构相对平缓，可以用较稀疏的 k 点网格。
  - **体系维度**：对于二维材料，在非周期性方向（通常是 z 方向）的 k 点数通常取 1。
  - 对于大体系，有时会仅使用 Gamma 点 (`gamma_only`参数) 以降低计算成本。
- **高对称性路径**：在计算能带结构时，通常会沿着第一布里渊区内的高对称性点（如$\Gamma, X, M, K, L$等）之间的连线选取 k 点路径。

---

## 八、收敛性测试 (Convergence Tests) ⚙️

为了获得可靠且高效的 DFT 计算结果，必须对计算参数进行收敛性测试。这主要是确保所选参数（如 $E_{cut}$ 和 k 点网格密度）足够精确，同时避免不必要的计算浪费。收敛性通常通过监控总能量或其它物理量随参数的变化来判断。

### 8.1 能量截断 ($E_{cut}$) 收敛性测试

此测试主要针对平面波基组。

- **目的**：确定一个足够大的 $E_{cut}$ 值，使得计算结果（如总能量）不再随 $E_{cut}$ 的进一步增加而发生显著变化。
- **过程**：选择一系列递增的 $E_{cut}$ 值，保持其他所有参数（如 k 点网格、原子结构、XC 泛函）不变，进行一系列单点能 SCF 计算。然后分析总能量（通常是单原子能量）随 $E_{cut}$ 的变化。
- **判据**：当相邻两次 $E_{cut}$ 计算得到的总能量差小于某个阈值（例如，文献中常用 $1 \text{ meV/atom}$）时，认为 $E_{cut}$ 达到收敛。
- **注意**：如果更换了赝势，需要重新进行 $E_{cut}$ 的收敛性测试。

### 8.2 k 点取样 (k-point Mesh) 收敛性测试

此测试对平面波和 LCAO 基组（用于周期性体系）都适用。

- **目的**：确定一个足够密的 k 点网格，使得对布里渊区的积分足够精确，计算结果（如总能量）不再随 k 点密度的进一步增加而发生显著变化。
- **过程**：选择一系列密度递增的 k 点网格（例如，$2\times2\times2, 3\times3\times3, \dots$），保持其他所有参数（如已收敛的 $E_{cut}$、原子结构、XC 泛函）不变，进行一系列单点能 SCF 计算。然后分析总能量（通常是单原子能量）随 k 点网格密度的变化。
- **判据**：当相邻两次不同 k 点密度计算得到的总能量差小于某个阈值（例如，$1 \text{ meV/atom}$）时，认为 k 点网格达到收敛。同时也可以关注计算时间的变化，以平衡精度和效率。
- **对称性**：开启对称性分析 (`symmetry 1`) 可以利用晶格对称性减少实际计算的 k 点数目（即只在不可约布里渊区取点），从而提高效率。

---

## 九、典型的 DFT 计算工作流程 📊

一个完整的 DFT 计算项目通常包含以下步骤，其核心是电子自洽迭代计算 (SCF)。

### 9.1 输入文件准备

典型的 DFT 计算至少需要以下几类输入信息（以 ABACUS 为例，这些信息分布在 `STRU`、`KPT` 和 `INPUT` 文件中）：

1.  **结构信息 (`STRU` 文件或类似文件)**：

    - 原子种类及其赝势文件名称（赝势文件需存放在`pseudo_dir`指定的目录）。
    - 如果使用 LCAO 基组，则需要数值原子轨道文件名称（轨道文件需存放在`orbital_dir`指定的目录）。
    - 晶格常数（整体缩放因子）和晶格矢量（定义原胞）。
    - 原子在晶胞内的坐标（分数坐标或笛卡尔坐标）及初始磁矩（如果考虑自旋极化）。
    - 原子是否允许移动的约束（用于结构优化）。

2.  **K 点信息 (`KPT` 文件或类似文件)**：

    - 布里渊区 k 点采样的方案，如 MP 网格的密度 ($N_x \times N_y \times N_z$) 和偏移（如 Gamma 中心）。
    - 或者指定高对称性路径上的 k 点用于能带结构计算。

3.  **计算参数 (`INPUT` 文件或类似文件)**：
    - **基本参数**：
      - `suffix`: 作业后缀，用于命名输出目录。
      - `calculation`: 计算类型，如 `scf` (自洽场计算)、`relax` (结构优化)、`cell-relax` (晶胞优化)、`md` (分子动力学)。
      - `symmetry`: 是否使用对称性来约化 k 点。
      - `basis_type`: 基组类型，如 `pw` (平面波) 或 `lcao` (局域原子轨道)。
      - `ecutwfc`: 平面波能量截断 (单位 Ry)。
      - 交换关联泛函的选择（通常通过赝势的命名或特定参数指定，如 PBE 泛函对应`*_PBE_*.UPF`赝势）。
    - **SCF 迭代参数**：
      - `scf_nmax`: SCF 最大迭代次数。
      - `scf_thr`: SCF 收敛阈值（例如，基于电荷密度或能量变化）。
    - **Kohn-Sham 方程求解参数**：
      - `nbands`: 计算的能带数目（Kohn-Sham 轨道数）。
      - `ks_solver`: 对角化求解器类型。
    - **展宽技术参数** (主要用于金属体系)：
      - `smearing_method`: 展宽方法，如 `gauss`, `mp`, `fd`。
      - `smearing_sigma`: 展宽能量宽度。
    - **电荷密度混合参数**：
      - `mixing_type`: 混合算法，如 `plain`, `pulay`, `broyden`。
      - `mixing_beta`: 新电荷密度混合比例。
    - 其他参数：如自旋极化设置 (`nspin`)，收敛阈值等。

### 9.2 执行 SCF 计算 (单点能计算)

对于给定的、固定的原子构型，DFT 软件会执行 SCF 迭代循环，直到电子结构（电子密度、总能量）收敛。这个过程通常称为**单点能计算 (single-point energy calculation)**，因为它计算的是该特定几何构型下的能量。

### 9.3 分析初步输出结果

SCF 计算完成后，可以得到：

- **体系的总能量**。
- **每个原子上的受力 (forces)**：如果原子未处于平衡位置，力不为零。
- **体系的应力张量 (stress tensor)** (对于周期性体系，如果晶胞未处于平衡形状或体积，应力不为零)。
- **电子密度分布 $n(\vec{r})$**。
- **Kohn-Sham 轨道和轨道能量 $\epsilon_i$**：可以用来绘制能带结构 (band structure) 和态密度 (Density of States, DOS)。
- **费米能级**。

这些信息通常记录在输出文件和日志文件中 (如 ABACUS 的`OUT.suffix`目录下的 `running_scf.log`)。

### 9.4 后续计算与应用

基于单点能计算的结果，可以进行更复杂的模拟和性质预测：

- **几何结构优化 (Relaxation)**：

  - 如果初始结构并非平衡结构（原子受力不为零），则需要进行结构优化 (对应`calculation = relax`或`cell-relax`)。
  - 优化算法会根据原子上的力来调整原子的位置（`cell-relax`还会调整晶胞参数），然后对新的结构重新进行 SCF 计算以获得新的能量和力。
  - 这个“移动原子 -> SCF 计算”的过程被称为一个**离子步 (ionic step)**。
  - 离子步会不断迭代，直到所有原子上的力都小于预设的力收敛阈值 (`force_thr_ev`)，并且对于 `cell-relax`，应力也小于应力收敛阈值 (`stress_thr`)，表明体系达到了（局部）能量最低的平衡结构。

- **分子动力学模拟 (Ab Initio Molecular Dynamics, AIMD)**：

  - 利用 DFT 实时计算原子间的相互作用力 (对应`calculation = md`)。
  - 通过数值积分牛顿运动方程，模拟原子在有限温度下的运动轨迹。
  - 可以研究体系的动态行为、相变、扩散等过程，并计算热力学平均性质。

- **材料性质预测**：
  - **电子性质**：能带结构、态密度、费米面、有效质量、功函数等。
  - **结构性质**：平衡晶格常数、体模量、相稳定性等。
  - **振动性质 (声子谱)**：通过密度泛函微扰理论 (DFPT) 或有限位移法计算动力学矩阵，得到声子色散关系和声子态密度，进而分析晶格稳定性、热容、热导率等。
  - **弹性性质**：计算弹性常数张量。
  - **光学性质**：计算介电函数、吸收谱、折射率等 (通常需要 TDDFT 或基于电子结构的近似方法)。
  - **磁学性质**：自旋磁矩、磁各向异性、交换作用参数等。
  - **反应路径与能垒**：使用如微扰弹性带 (Nudged Elastic Band, NEB) 方法寻找化学反应的过渡态和活化能。

---

## 十、DFT 的优势与局限性 👍👎

### 优势 (Strengths)

- **良好的精度与成本平衡**：对于许多体系（特别是固态材料和较大分子）的基态性质，DFT 能够在可接受的计算成本下提供相对较高的精度。
- **第一性原理方法**：在选定交换关联泛函后，不需要针对特定体系的经验参数（尽管泛函本身是通过拟合或满足某些物理约束来构建的）。
- **广泛的适用性**：可以应用于金属、半导体、绝缘体、分子、表面、缺陷等多种体系。
- **可预测性**：能够预测未知材料的性质。

### 局限性 (Limitations)

- **交换关联泛函的近似性**：这是 DFT 最主要的误差来源。
  - **没有系统改进的方法**：不像波函数理论中的方法（如 CI, CC）可以通过增加计算量系统地提高精度。
  - **特定问题体系**：
    - **强关联体系** (如某些过渡金属氧化物、f 电子体系的 Mott 绝缘体)：标准 LDA/GGA 泛函通常会失效，需要更高级的方法 (如 DFT+U, DMFT) (提及平面波局限性)。
    - **带隙问题**：LDA/GGA 通常严重低估半导体和绝缘体的带隙。杂化泛函或 GW 近似能显著改善，但计算成本更高。
    - **范德华 (van der Waals) 作用 / 色散力**：标准 LDA/GGA 不能很好地描述长程色散力，对于分子晶体、层状材料、吸附体系等可能不准确。现代 DFT 方法已发展出多种色散修正方案 (如 DFT-D, vdW-DF)。
    - **激发态性质**：标准的 Kohn-Sham DFT 本质上是基态理论。虽然 KS 轨道能量有时被用来近似分析激发态，但严格处理激发态需要时间相关的 DFT (Time-Dependent DFT, TDDFT) 或其他激发态方法（如 GW-BSE）。TDDFT 本身也有其近似和局限性。
- **计算标度 (Computational Scaling)**：DFT 的计算成本通常随体系尺寸 $N$（如电子数或基函数数目）的增加而成 $N^3$（立方标度）或更高（对于杂化泛函等）的比例增长。这限制了能够模拟的体系尺寸（通常在几百到几千个原子） (提及平面波计算量随体系尺寸剧增)。
- **赝势的近似性** (如果使用)：赝势本身也是一种近似，其选择和质量会影响计算结果。

尽管存在这些局限性，DFT 依然是目前材料科学、计算化学和凝聚态物理领域中最流行和最强大的计算工具之一。对其原理、近似和适用范围的理解，对于有效地使用 DFT 工具并正确解读计算结果至关重要。
